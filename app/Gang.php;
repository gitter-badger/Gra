<?php

namespace HempEmpire;

use Config;
use Illuminate\Database\Eloquent\Model;

class Gang extends Model {
	protected $fillable = ['world_id', 'name', 'attackLevel', 'defenseLevel', 'accomodationLevel', 'money', 'respect', 'startAttack', 'endAttack'];
	public $timestamps  = true;

	public function world() {
		return $this->belongsTo(World::class );
	}

	public function members() {
		return $this->hasMany(GangMember::class );
	}

	public function invitations() {
		return $this->hasMany(PlayerInvitation::class );
	}

	public function getMembersCountAttribute() {
		return $this->members()->count()+$this->invitations()->count();
	}

	public function getLevelAttribute() {
		$q = $this->members()->leftJoin('players', 'gang_members.player_id', '=', 'players.id');

		return round($q->sum('level')/$q->count());
	}

	public function getAccomodationUpgradeCostAttribute() {
		return round(exp($this->accomodationLevel)*Config::get('gang.upgrade.accomodation.cost'));
	}

	public function getAccomodationMaxLevel() {
		return Config::get('gang.upgrade.accomodation.maxLevel');
	}

	public function getAttackUpgradeCostAttribute() {
		return round(exp($this->attackLevel)*Config::get('gang.upgrade.attack.cost'));
	}

	public function getAttackMaxLevel() {
		return Config::get('gang.upgrade.attack.maxLevel');
	}

	public function getDefenseUpgradeCostAttribute() {
		return round(exp($this->defenseLevel)*Config::get('gang.upgrade.defense.cost'));
	}

	public function getDefenseMaxLevel() {
		return Config::get('gang.upgrade.defense.maxLevel');
	}

	public function getMembersLimitAttribute() {
		return $this->accomodationLevel+3;
	}
}
